package csci498.cahurley.lunchlist;

import csci498.cahurley.lunchlist.LunchList.RestaurantAdapter;
import android.app.Activity;
import android.content.Intent;
import android.content.SharedPreferences;
import android.database.Cursor;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuInflater;
import android.view.MenuItem;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RadioGroup;

public class DetailForm extends Activity 
{
	EditText name = null;
	EditText address = null;
	EditText notes = null;
	RadioGroup types = null;
	RestaurantHelper helper = null;
	String restaurantId = null;
	
	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.detail_form);
		
		setMemberVariables();
		
		configureSaveButton();
		
		restaurantId = getIntent().getStringExtra(LunchList.ID_EXTRA);
		if(restaurantId != null)
		{
			load();
		}
	}
	
    private void setMemberVariables()
    {
    	helper = new RestaurantHelper(this);
    	name = (EditText)findViewById(R.id.name_edit_text);
    	address = (EditText)findViewById(R.id.address_edit_text);
    	types = (RadioGroup)findViewById(R.id.types_of_restaurants_radio);
    	notes = (EditText)findViewById(R.id.notes_edit_text);
    }
    
    private void configureSaveButton()
    {
        Button saveButton = (Button)findViewById(R.id.save_button);
        saveButton.setOnClickListener(onSave);
    }
    
    @Override
    public boolean onCreateOptionsMenu(Menu menu)
    {
    	new MenuInflater(this).inflate(R.menu.option, menu);
    	return(super.onCreateOptionsMenu(menu));
    }
    
    @Override
    public boolean onOptionsItemSelected(MenuItem item)
    {
    	if(item.getItemId() == R.id.preferences)
    	{
    		startActivity(new Intent(DetailForm.this, EditPreferences.class));
    		
    		return(true);
    	}
    	
    	return(super.onOptionsItemSelected(item));
    }
    
    @Override
    public void onDestroy()
    {
    	super.onDestroy();
    	
    	helper.close();
    }
    
    private void load()
    {
    	Cursor cursor = helper.getById(restaurantId);
    	
    	cursor.moveToFirst();
    	name.setText(helper.getName(cursor));
    	address.setText(helper.getAddress(cursor));
    	notes.setText(helper.getNotes(cursor));
    	
    	String type = helper.getType(cursor);
    	if(type.equals("sit_down"))
    	{
    		types.check(R.id.sit_down);
    	}
    	else if(type.equals("take_out"))
    	{
    		types.check(R.id.take_out);
    	}
    	else
    	{
    		types.check(R.id.delivery);
    	}
    	
    	cursor.close();
    }
    
    private void initList()
    {
    	if(restaurants != null)
    	{
    		stopManagingCursor(restaurants);
    		restaurants.close();
    	}
    	
    	restaurants = helper.getAll(preferences.getString("sort_order", "name"));
    	startManagingCursor(restaurants);
    	adapter = new RestaurantAdapter(restaurants);
    	setListAdapter(adapter);
    }
	
    private SharedPreferences.OnSharedPreferenceChangeListener preferenceListener = new SharedPreferences.OnSharedPreferenceChangeListener()
    {	
		public void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String key) 
		{
			if(key.equals("sort_order"))
			{
				initList();
			}
		}
	};
    
    private View.OnClickListener onSave = new View.OnClickListener()
    {	
		public void onClick(View v) 
		{
			String type = getRestaurantType();
			
			if(restaurantId == null)
			{
				helper.insert(name.getText().toString(), address.getText().toString(), type, notes.getText().toString());
			}
			else
			{
				helper.update(restaurantId, name.getText().toString(), address.getText().toString(), type, notes.getText().toString());
			}
			
			finish();
		}
		
		String getRestaurantType()
		{
			switch(types.getCheckedRadioButtonId())
			{
				case R.id.sit_down:
					return("sit_down");
				case R.id.take_out:
					return("take_out");
				case R.id.delivery:
					return("delivery");
				default:
					return("sit_down");
			}
		}
		
	};
}
